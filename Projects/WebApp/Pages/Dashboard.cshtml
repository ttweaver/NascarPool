@page
@model WebApp.Pages.DashboardModel
@{
    ViewData["Title"] = "Dashboard";
}
<h1>Dashboard</h1>

<div class="mb-2 text-muted">
    @if (Model.CurrentRace != null)
    {
        <span> This week's race: </span>
        <span class="fw-semibold">@Model.CurrentRace.Name</span>
        <span class="ms-2">(@Model.CurrentRaceNumber of @Model.TotalRaces)</span>
    }
    else
    {
        <span>No upcoming race</span>
        <span class="ms-2">(@Model.TotalRaces race@(Model.TotalRaces == 1 ? "" : "s") this season)</span>
    }
</div>

<div class="row mb-4">
    <!-- Overall Place Tile (clickable, with tooltip) -->
    <div class="col-md-6 mb-3">
        <a href="/Standings" class="text-decoration-none" title="Click here to see how you stack up!">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Overall Place</h5>
                    @if (!Model.HasResults)
                    {
                        <div class="text-secondary">There are no standings available yet for this season.</div>
                    }
                    else
                    {
                        <div class="display-4 fw-bold text-primary">@Model.OverallPlace</div>
                    }
                </div>
            </div>
        </a>
    </div>

    <!-- Total Points Tile (clickable, with tooltip) -->
    <div class="col-md-6 mb-3">
        <a href="/Standings" class="text-decoration-none" title="Click here to see how you stack up!">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Points</h5>
                    @if (!Model.HasResults)
                    {
                        <div class="text-secondary">No points available yet for this season.</div>
                    }
                    else
                    {
                        <div class="display-4 fw-bold text-success">@Model.TotalPoints</div>
                    }
                    <div class="mt-2 text-muted">Races this season: @Model.TotalRaces</div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Picks for Current Week and Player Results on the same row -->
@if (Model.CurrentRace != null)
{
    <div class="row mb-4">
        <!-- Picks for Current Week Tile -->
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Picks for This Week</h5>
                    <div class="mb-2 text-muted">
                        @(Model.CurrentRace != null && !string.IsNullOrWhiteSpace(Model.CurrentRace.Name)
                            ? $"{Model.CurrentRace.Name} — {Model.CurrentRace.Date.ToString("MMMM d, yyyy")}"
                            : "N/A")
                    </div>

                    @{

                        int? daysUntilRace = Model.CurrentRace != null ? (Model.CurrentRace.Date.Date - DateTime.Today).Days : (int?)null;
                    }

                    @if (Model.CurrentWeekPick != null)
                    {
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">Primary: @Model.CurrentWeekPick.Pick1?.Name (@Model.CurrentWeekPick.Pick1?.CarNumber)</li>
                            <li class="list-group-item">Pick 2: @Model.CurrentWeekPick.Pick2?.Name (@Model.CurrentWeekPick.Pick2?.CarNumber)</li>
                            <li class="list-group-item">Pick 3: @Model.CurrentWeekPick.Pick3?.Name (@Model.CurrentWeekPick.Pick3?.CarNumber)</li>
                        </ul>

                        @if (daysUntilRace.HasValue && daysUntilRace.Value >= 1 && daysUntilRace.Value <= 3)
                        {
                            <div class="alert alert-warning mt-2 mb-2" role="alert">
                                Hurry — only @daysUntilRace.Value day@(daysUntilRace.Value == 1 ? "" : "s") left to change your picks.
                            </div>
                        }

                        @if (Model.CurrentRace != null && Model.CurrentRace.Date > DateTime.Today)
                        {
                            <a href="/Races/Picks/Edit/@Model.CurrentRace?.Id" class="btn btn-primary">Change your picks for this week</a>
                        }
                        else
                        {
                            <span title="You cannot change your picks on or after race day." tabindex="0">
                                <a href="/Races/Picks/@Model.CurrentRace?.Id" class="btn btn-primary">See all picks for this week</a>
                            </span>
                        }
                    }
                    else
                    {
                        <div class="text-secondary">You have not made picks for this week.</div>

                        @if (daysUntilRace.HasValue && daysUntilRace.Value >= 1 && daysUntilRace.Value <= 3)
                        {
                            <div class="alert alert-warning mt-2 mb-2" role="alert">
                                Hurry — only @daysUntilRace.Value day@(daysUntilRace.Value == 1 ? "" : "s") left to make your picks.
                            </div>
                        }

                        @if (Model.CurrentRace != null && Model.CurrentRace.Date > DateTime.Today)
                        {
                            <a href="/Races/Pick/@Model.CurrentRace?.Id" class="btn btn-primary">Make your picks for this week</a>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Current Week Race Results Tile (Player Standings) -->
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">This Week's Player Results</h5>
                    <div class="mb-2 text-muted">
                        @Model.CurrentRace.Name — @Model.CurrentRace.Date.ToString("MMMM d, yyyy")
                    </div>

                    @if (Model.CurrentWeekPlayerResults != null && Model.CurrentWeekPlayerResults.Any())
                    {
                        <table class="table table-sm table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>Place</th>
                                    <th>Player</th>
                                    <th>Points</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var result in Model.CurrentWeekPlayerResults)
                                {
                                    var isCurrentUser = result.PlayerName == User.Identity?.Name;
                                    <tr class="@(isCurrentUser ? "table-primary" : "")">
                                        <td class="fw-bold">@result.Place</td>
                                        <td>@result.PlayerName @(isCurrentUser ? "(You)" : "")</td>
                                        <td>@result.Points</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        <a href="/Standings?raceId=@Model.CurrentRace.Id" class="btn btn-outline-primary btn-sm">View Full Details</a>
                    }
                    else if (Model.CurrentRace.Date <= DateTime.Today)
                    {
                        <div class="alert alert-info" role="alert">
                            <strong>Results Coming Soon!</strong> Player results for this race are typically available within 2-3 days after the race concludes. Check back soon!
                        </div>
                    }
                    else
                    {
                        <div class="text-secondary">
                            Player results will be available after the race is completed (typically within 2-3 days).
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- Primary Driver Tile (First Half) -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-body text-center">
                <h5 class="card-title">Primary Driver (First Half)</h5>
                @if (Model.PrimaryDriver != null)
                {
                    <div class="mb-2 fw-bold text-info">
                        @Model.PrimaryDriver.Name (@Model.PrimaryDriver.CarNumber)
                    </div>
                }
                else
                {
                    <div class="text-secondary mb-2">No primary driver set.</div>
                }
                @if (Model.FirstRace != null && Model.FirstRace.Date > DateTime.Today)
                {
                    <form method="post" asp-page-handler="SetPrimaryDriver" class="d-inline">
                        <select id="driverSelectFirst" name="driverId" class="form-select mb-2" required>
                            <option value="">Select driver...</option>
                            @foreach (var driver in Model.AvailableDrivers)
                            {
                                var selected = Model.PrimaryDriver != null && Model.PrimaryDriver.Id == driver.Id ? "selected" : "";
                                <option value="@driver.Id" selected="@(selected == "selected" ? "selected" : null)">
                                    @driver.Name (@driver.CarNumber)
                                </option>
                            }
                        </select>
                        <button id="driverSubmitFirst" type="submit" class="btn btn-primary" disabled>Set Primary Driver</button>
                    </form>
                    <div class="form-text">You can set your primary driver until @Model.FirstRace.Date.ToString("MMMM d, yyyy").</div>
                }
                else
                {
                    <div class="form-text text-secondary">Primary driver selection is closed.</div>
                }
            </div>
        </div>
    </div>

    <!-- Primary Driver Tile (Second Half) -->
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-body text-center">
                <h5 class="card-title">Primary Driver (Second Half)</h5>
                @if (Model.SecondHalfPrimaryDriver != null)
                {
                    <div class="mb-2 fw-bold text-info">
                        @Model.SecondHalfPrimaryDriver.Name (@Model.SecondHalfPrimaryDriver.CarNumber)
                    </div>
                }
                else
                {
                    <div class="text-secondary mb-2">No primary driver set.</div>
                }
                @if (Model.SecondHalfFirstRace != null && Model.SecondHalfFirstRace.Date > DateTime.Today)
                {
                    <form method="post" asp-page-handler="SetPrimarySecondHalfDriver" class="d-inline">
                        <select id="driverSelectSecond" name="secondHalfDriverId" class="form-select mb-2" required>
                            <option value="">Select driver...</option>
                            @foreach (var driver in Model.AvailableDrivers)
                            {
                                var selected = Model.SecondHalfPrimaryDriver != null && Model.SecondHalfPrimaryDriver.Id == driver.Id ? "selected" : "";
                                <option value="@driver.Id" selected="@(selected == "selected" ? "selected" : null)">
                                    @driver.Name (@driver.CarNumber)
                                </option>
                            }
                        </select>
                        <button id="driverSubmitSecond" type="submit" class="btn btn-primary" disabled>Set Primary Driver</button>
                    </form>
                    <div class="form-text">You can set your primary driver until @Model.SecondHalfFirstRace.Date.ToString("MMMM d, yyyy").</div>
                }
                else
                {
                    <div class="form-text text-secondary">Primary driver selection is closed.</div>
                }
            </div>
        </div>
    </div>
</div>


<!-- Most Recent Race Results Tile in its own row, full width -->
<div class="row mb-4">
    <div class="col-12 mb-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Most Recent Race Results</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="toggleResultsBtn" type="button" aria-expanded="true" aria-controls="raceResultsContent">
                        <span id="toggleIcon">−</span>
                    </button>
                </div>

                <div id="raceResultsContent" class="mt-3">
                    @* Race selector: only show when there are races with results *@
                    @if (Model.RacesWithResults != null && Model.RacesWithResults.Any())
                    {
                        var selectedRaceId = Model.RecentResults?.OrderByDescending(rr => rr.Id).FirstOrDefault()?.Race?.Id ?? Model.RacesWithResults.First().Id;
                        <div class="mb-2 d-flex align-items-center">
                            <label for="raceSelect" class="me-2 mb-0">Race:</label>
                            <select id="raceSelect" class="form-select w-auto">
                                @foreach (var race in Model.RacesWithResults)
                                {
                                    var optSelected = race.Id == selectedRaceId ? "selected" : "";
                                    <option value="@race.Id" data-name="@race.Name" data-date="@race.Date.ToString("MMMM d, yyyy")" selected="@(optSelected == "selected" ? "selected" : null)">
                                        @race.Name — @race.Date.ToString("MMMM d, yyyy")
                                    </option>
                                }
                            </select>
                        </div>
                    }
                    else
                    {
                        <div class="mb-2 text-muted">
                            @if (Model.RecentResults != null && Model.RecentResults.Any() && Model.RecentResults.FirstOrDefault()?.Race?.Name != null)
                            {
                                var recentRace = Model.RecentResults.FirstOrDefault().Race;
                                @($"{recentRace.Name} — {recentRace.Date.ToString("MMMM d, yyyy")}")
                            }
                        </div>
                    }

                    <!-- Search by driver (client-side, instant) -->
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" id="searchDriver" class="form-control" placeholder="Search by driver name" oninput="filterResultsAndPaginate()" />
                        </div>
                    </div>

                    <!-- Page size selector -->
                    <div class="mb-3 d-flex align-items-center">
                        <label for="pageSizeSelect" class="me-2 mb-0">Show:</label>
                        <select id="pageSizeSelect" class="form-select w-auto">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="ms-2">results per page</span>
                    </div>

                    <table class="table table-sm table-bordered mb-0" id="resultsTable">
                        <thead>
                            <tr>
                                <th>Place</th>
                                <th>Driver</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        @if (Model.AllRecentResults != null && Model.AllRecentResults.Any())
                        {
                            foreach (var result in Model.AllRecentResults)
                            {
                                <tr data-race-id="@result.Race.Id" data-race-name="@result.Race.Name" data-race-date="@result.Race.Date.ToString("MMMM d, yyyy")">
                                    <td>@result.Place</td>
                                    <td>@result.Driver.Name (@result.Driver.CarNumber)</td>
                                </tr>
                            }
                        }
                        else if (Model.RecentResults != null && Model.RecentResults.Any())
                        {
                            foreach (var result in Model.RecentResults)
                            {
                                <tr data-race-id="@result.Race.Id" data-race-name="@result.Race.Name" data-race-date="@result.Race.Date.ToString("MMMM d, yyyy")">
                                    <td>@result.Place</td>
                                    <td>@result.Driver.Name (@result.Driver.CarNumber)</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="2" class="text-secondary">No recent results available.</td>
                            </tr>
                        }
                        </tbody>
                    </table>

                    <!-- Pagination controls -->
                    <nav>
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination buttons will be rendered here by JS -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
let pageSize = 10;
let currentPage = 1;
let allRows = [];
let filteredRows = [];

// Cookie helper functions
function setCookie(name, value, days) {
    const expires = new Date();
    expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
}

function getCookie(name) {
    const nameEQ = name + '=';
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

// return currently selected race id (string) or null
function getSelectedRaceId() {
    const sel = document.getElementById('raceSelect');
    return sel ? sel.value : null;
}

function updateHeaderFromSelectedRace() {
    const sel = document.getElementById('raceSelect');
    if (!sel) return;
    const opt = sel.selectedOptions[0];
    if (!opt) return;
    const name = opt.dataset.name;
    const date = opt.dataset.date;
}

function filterResultsAndPaginate() {
    const input = document.getElementById('searchDriver');
    const filter = input.value.trim().toLowerCase();
    const selectedRaceId = getSelectedRaceId();

    filteredRows = allRows.filter(row => {
        // filter by race id first
        const rowRaceId = row.dataset.raceId;
        if (selectedRaceId && rowRaceId !== selectedRaceId) return false;

        if (!filter) return true;

        const driverCell = row.getElementsByTagName('td')[1];
        if (!driverCell) return false;
        const txtValue = driverCell.textContent || driverCell.innerText;
        return txtValue.toLowerCase().indexOf(filter) > -1;
    });

    currentPage = 1;
    renderPage();
}

function renderPage() {
    const tbody = document.getElementById('resultsBody');
    allRows.forEach(row => row.style.display = 'none');

    const rowsToShow = filteredRows;
    const totalRows = rowsToShow.length;
    const totalPages = Math.ceil(totalRows / pageSize);

    if (totalRows === 0) {
        const noResultsRow = document.createElement('tr');
        noResultsRow.innerHTML = '<td colspan="2" class="text-secondary">No recent results available.</td>';
        tbody.innerHTML = '';
        tbody.appendChild(noResultsRow);
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    tbody.innerHTML = '';
    for (let i = (currentPage - 1) * pageSize; i < Math.min(currentPage * pageSize, totalRows); i++) {
        tbody.appendChild(rowsToShow[i]);
        rowsToShow[i].style.display = '';
    }

    renderPagination(totalPages);
}

function renderPagination(totalPages) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';

    if (totalPages <= 1) return;

    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === currentPage ? ' active' : '' );
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = i;
        a.onclick = function(e) {
            e.preventDefault();
            currentPage = i;
            renderPage();
        };
        li.appendChild(a);
        pagination.appendChild(li);
    }
}

function setupSelectEnable(selectId, buttonId) {
    const select = document.getElementById(selectId);
    const btn = document.getElementById(buttonId);
    if (!select || !btn) return;
    const initial = select.value;
    // Ensure button is disabled until user changes selection
    btn.disabled = true;
    select.addEventListener('change', function() {
        // Enable only if a non-empty different value is selected
        btn.disabled = !(select.value && select.value !== initial);
    });
}

// Toggle race results section with cookie persistence
function setupRaceResultsToggle() {
    const toggleBtn = document.getElementById('toggleResultsBtn');
    const content = document.getElementById('raceResultsContent');
    const toggleIcon = document.getElementById('toggleIcon');
    
    if (!toggleBtn || !content || !toggleIcon) return;

    // Load saved state from cookie (default to expanded)
    const savedState = getCookie('raceResultsExpanded');
    const isExpanded = savedState === null ? true : savedState === 'true';

    // Set initial state
    if (!isExpanded) {
        content.style.display = 'none';
        toggleIcon.textContent = '+';
        toggleBtn.setAttribute('aria-expanded', 'false');
    }

    // Toggle on button click
    toggleBtn.addEventListener('click', function() {
        const currentlyExpanded = content.style.display !== 'none';
        const newState = !currentlyExpanded;
        
        content.style.display = newState ? 'block' : 'none';
        toggleIcon.textContent = newState ? '−' : '+';
        toggleBtn.setAttribute('aria-expanded', newState.toString());
        
        // Save state to cookie (365 days)
        setCookie('raceResultsExpanded', newState.toString(), 365);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    allRows = Array.from(document.querySelectorAll('#resultsTable tbody tr[data-race-id]'));
    // If there are no rows with data-race-id, fall back to any rows (to preserve "No recent results" row)
    if (!allRows.length) {
        allRows = Array.from(document.querySelectorAll('#resultsTable tbody tr'));
    }

    // Load page size from cookie
    const savedPageSize = getCookie('dashboardPageSize');
    if (savedPageSize) {
        pageSize = parseInt(savedPageSize, 10);
        const pageSizeSelect = document.getElementById('pageSizeSelect');
        if (pageSizeSelect) {
            pageSizeSelect.value = savedPageSize;
        }
    }

    // Handle page size change
    const pageSizeSelect = document.getElementById('pageSizeSelect');
    if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', function() {
            pageSize = parseInt(this.value, 10);
            setCookie('dashboardPageSize', pageSize, 365);
            currentPage = 1;
            renderPage();
        });
    }

    // Initialize race header and wire race select change
    const raceSelect = document.getElementById('raceSelect');
    if (raceSelect) {
        updateHeaderFromSelectedRace();
        raceSelect.addEventListener('change', function() {
            updateHeaderFromSelectedRace();
            filterResultsAndPaginate();
        });
    }

    // Setup race results toggle with cookie persistence
    setupRaceResultsToggle();

    // Perform initial filter based on selected race
    filterResultsAndPaginate();

    const search = document.getElementById('searchDriver');
    if (search) {
        search.addEventListener('input', filterResultsAndPaginate);
    }

    // Wire up primary driver selects so buttons remain disabled until selection changes
    setupSelectEnable('driverSelectFirst', 'driverSubmitFirst');
    setupSelectEnable('driverSelectSecond', 'driverSubmitSecond');
});
</script>
}